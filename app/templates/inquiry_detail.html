{% extends "layout.html" %}

{% block title %}Inquiry Detail - {{ inquiry.id }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2>Inquiry #{{ inquiry.id }}</h2>
        <a href="{{ url_for('main.dashboard_customer_view') }}" class="btn btn-sm btn-outline-secondary">Back to Dashboard</a>
    </div>

    {# Display a prominent alert if the Inquiry status indicates an error #}
    {% if inquiry.status in ['Error', 'Processing Failed'] %}
    <div class="alert alert-danger" role="alert">
        <h4 class="alert-heading"><i class="fas fa-exclamation-triangle me-2"></i>Processing Issue</h4>
        <p>This inquiry encountered an issue during processing. The status is currently: <strong>{{ inquiry.status }}</strong>.</p>
        <hr>
        <p class="mb-0">Please review the communication timeline below for specific error messages related to emails or other communications. If the issue persists, technical assistance may be required.</p>
    </div>
    {% endif %}

    <div class="card mb-4">
        <div class="card-header">
            Inquiry Details
        </div>
        <div class="card-body">
            <p><strong>ID:</strong> {{ inquiry.id }}</p>
            <p><strong>Contact:</strong> {{ inquiry.customer_email if inquiry.customer_email else inquiry.customer_phone }}</p>
            <p><strong>Status:</strong> <span class="badge bg-info text-dark">{{ inquiry.status }}</span></p>
            <p><strong>Created At:</strong> {{ inquiry.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</p>
            <p><strong>Last Updated:</strong> {{ inquiry.updated_at.strftime('%Y-%m-%d %H:%M:%S') }}</p>
            {% if inquiry.summary %}
            <p><strong>AI Summary:</strong></p>
            <pre class="bg-light p-2 rounded">{{ inquiry.summary }}</pre>
            {% endif %}
            {% if inquiry.extracted_data %}
            <p><strong>AI Extracted Data:</strong></p>
            <div class="d-flex justify-content-between align-items-start">
                <pre class="bg-light p-2 rounded mb-0 flex-grow-1">{{ inquiry.extracted_data.data | tojson(indent=2) }}</pre>
                <a href="{{ url_for('main.edit_extracted_data_form', data_id=inquiry.extracted_data.id) }}" class="btn btn-sm btn-outline-primary ms-3">
                    <i class="fas fa-edit me-1"></i> Edit Data
                </a>
            </div>
            <p class="mt-2"><small>Validation Status: {{ inquiry.extracted_data.validation_status | title }}</small></p>
            {% if inquiry.extracted_data.updated_by_user %}
            <p><small>Last Edited By: {{ inquiry.extracted_data.updated_by_user.username }} at {{ inquiry.extracted_data.updated_at.strftime('%Y-%m-%d %H:%M') }}</small></p>
            {% endif %}
            {% else %}
            <p>No extracted data available for this inquiry yet.</p>
            {% endif %}
                                        </div>
                                    </div>
                                    
    <h3 class="mb-3">Communication Timeline</h3>

    {% if timeline %}
        {% for item in timeline %}
            <div class="card mb-3">
                <div class="card-header d-flex justify-content-between">
                    <span>
                        {% if item.type == 'email' %}
                            <i class="fas fa-envelope me-2"></i> Email from: {{ item.sender_email }}
                        {% elif item.type == 'whatsapp' %}
                            <i class="fab fa-whatsapp me-2"></i> WhatsApp from: {{ item.data.sender_number if item.data.from_me == False else 'Me (' + item.data.wa_chat_id + ')' }}
                        {% endif %}
                    </span>
                    <small class="text-muted">{{ item.timestamp.strftime('%Y-%m-%d %H:%M:%S') }}</small>
                                        </div>
                <div class="card-body">
                    {% if item.type == 'email' %}
                        <h5 class="card-title">{{ item.subject }}</h5>
                        <p class="card-text">To: {{ item.recipient_email }}</p>
                        <hr>
                        <p><strong>Original Received At:</strong> {{ item.original_received_at.strftime('%Y-%m-%d %H:%M:%S') if item.original_received_at else 'N/A' }}</p>
                        <pre class="email-body bg-light p-3 rounded">{{ item.body }}</pre>
                    {% elif item.type == 'whatsapp' %}
                        <p class="card-text">{{ item.data.body if item.data.body else '(No text content)' }}</p>
                        {% if item.data.media_url %}
                            <p><i class="fas fa-paperclip me-1"></i> <a href="{{ item.data.media_url }}" target="_blank" rel="noopener noreferrer">View Media</a> ({{ item.data.media_mime_type if item.data.media_mime_type else 'media' }})</p>
                        {% endif %}
                    {% endif %}
                </div>
                {% if item.type == 'email' %}
                <div class="card-footer text-muted">
                    Status: {{ item.status }}
                    {% if item.error_message %}
                        <span class="text-danger ms-2">Error: {{ item.error_message }}</span>
                    {% endif %}
                </div>
                {% endif %}
            </div>
        {% endfor %}
    {% else %}
        <p>No communications found for this inquiry.</p>
    {% endif %}

</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
<style>
    .email-body {
        white-space: pre-wrap; /* css-3 */
        white-space: -moz-pre-wrap; /* Mozilla, since 1999 */
        white-space: -pre-wrap; /* Opera 4-6 */
        white-space: -o-pre-wrap; /* Opera 7 */
        word-wrap: break-word; /* Internet Explorer 5.5+ */
    }
    .badge.bg-info { /* More readable status badge */
        color: #000 !important;
    }
</style>
{% endblock %}
